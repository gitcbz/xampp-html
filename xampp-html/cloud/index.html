<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°äº‘ç›˜ - Cloud Storage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        /* å¤´éƒ¨ */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .logo-icon {
            font-size: 32px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
        }

        .storage-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 5px;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-icon {
            font-size: 20px;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* å·¥å…·æ  */
        .toolbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            border: none;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4);
        }

        /* æœç´¢æ¡† */
        .search-box {
            position: relative;
        }

        .search-input {
            padding: 8px 16px 8px 40px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            width: 250px;
            font-size: 14px;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
        }

        /* è·¯å¾„å¯¼èˆª */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: all 0.3s;
        }

        .breadcrumb-item:hover {
            color: #00d2ff;
        }

        .breadcrumb-separator {
            color: rgba(255, 255, 255, 0.5);
        }

        /* æ–‡ä»¶ç½‘æ ¼ */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border: 2px solid transparent;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .file-item.selected {
            border-color: #00d2ff;
            background: rgba(0, 210, 255, 0.2);
        }

        .file-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .file-name {
            color: white;
            font-size: 14px;
            word-break: break-word;
            margin-bottom: 5px;
        }

        .file-size {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .file-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 18px;
            height: 18px;
            accent-color: #00d2ff;
        }

        .file-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
            padding: 5px;
            display: none;
        }

        .file-menu.show {
            display: block;
        }

        .menu-item {
            padding: 5px 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* åˆ—è¡¨è§†å›¾ */
        .file-list {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
        }

        .file-list-header {
            display: grid;
            grid-template-columns: 40px 1fr 100px 150px 100px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .file-list-item {
            display: grid;
            grid-template-columns: 40px 1fr 100px 150px 100px;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-list-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .file-list-item.selected {
            background: rgba(0, 210, 255, 0.2);
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            color: white;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #00d2ff;
            background: rgba(0, 210, 255, 0.1);
        }

        .upload-area.dragover {
            border-color: #00d2ff;
            background: rgba(0, 210, 255, 0.2);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #00d2ff;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            width: 0%;
            transition: width 0.3s;
        }

        /* å­˜å‚¨ç©ºé—´æ¡ */
        .storage-bar {
            width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .storage-fill {
            height: 100%;
            background: linear-gradient(45deg, #00ff00, #00d2ff);
            transition: width 0.3s;
        }

        /* å³é”®èœå• */
        .context-menu {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 8px;
            padding: 5px 0;
            min-width: 150px;
            z-index: 1001;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 8px 16px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* è¿”å›æŒ‰é’® */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            font-size: 16px;
            z-index: 1000;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                width: 100%;
            }
            
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .file-list-header,
            .file-list-item {
                grid-template-columns: 1fr 80px 100px;
            }
            
            .file-list-header > :first-child,
            .file-list-item > :first-child {
                display: none;
            }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
    
    <!-- å¤´éƒ¨ -->
    <header class="header">
        <div class="logo">
            <span class="logo-icon">â˜ï¸</span>
            <span>æœ¬åœ°äº‘ç›˜</span>
        </div>
        <div class="user-info">
            <div class="storage-info">
                <span>å­˜å‚¨ç©ºé—´: </span>
                <div class="storage-bar">
                    <div class="storage-fill" id="storageFill"></div>
                </div>
                <span id="storageText">0 MB / 100 MB</span>
            </div>
            <div class="user-avatar">ğŸ‘¤</div>
        </div>
    </header>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="nav-item active" data-view="all">
                <span class="nav-icon">ğŸ“</span>
                <span>æ‰€æœ‰æ–‡ä»¶</span>
            </div>
            <div class="nav-item" data-view="images">
                <span class="nav-icon">ğŸ–¼ï¸</span>
                <span>å›¾ç‰‡</span>
            </div>
            <div class="nav-item" data-view="documents">
                <span class="nav-icon">ğŸ“„</span>
                <span>æ–‡æ¡£</span>
            </div>
            <div class="nav-item" data-view="videos">
                <span class="nav-icon">ğŸ¥</span>
                <span>è§†é¢‘</span>
            </div>
            <div class="nav-item" data-view="music">
                <span class="nav-icon">ğŸµ</span>
                <span>éŸ³ä¹</span>
            </div>
            <div class="nav-item" data-view="others">
                <span class="nav-icon">ğŸ“¦</span>
                <span>å…¶ä»–</span>
            </div>
            <div class="nav-item" data-view="trash">
                <span class="nav-icon">ğŸ—‘ï¸</span>
                <span>å›æ”¶ç«™</span>
            </div>
        </aside>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="content">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn btn-primary" onclick="showNewFolderModal()">
                        <span>ğŸ“</span>
                        <span>æ–°å»ºæ–‡ä»¶å¤¹</span>
                    </button>
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        <span>ğŸ“¤</span>
                        <span>ä¸Šä¼ æ–‡ä»¶</span>
                    </button>
                    <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileUpload(event)">
                </div>
                <div class="toolbar-right">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="search-input" placeholder="æœç´¢æ–‡ä»¶..." oninput="searchFiles(this.value)">
                    </div>
                    <button class="btn" onclick="toggleView()">
                        <span id="viewIcon">ğŸ“‹</span>
                        <span>åˆ‡æ¢è§†å›¾</span>
                    </button>
                </div>
            </div>

            <!-- è·¯å¾„å¯¼èˆª -->
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item" onclick="navigateToPath('/')">æ ¹ç›®å½•</span>
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">â˜ï¸</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <div class="upload-hint">æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 1GB</div>
            </div>

            <!-- æ–‡ä»¶ç½‘æ ¼ -->
            <div class="file-grid" id="fileGrid"></div>

            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div class="file-list" id="fileList" style="display: none;"></div>
        </main>
    </div>

    <!-- æ–°å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡† -->
    <div class="modal" id="newFolderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ–°å»ºæ–‡ä»¶å¤¹</h3>
                <button class="modal-close" onclick="closeModal('newFolderModal')">âœ•</button>
            </div>
            <div class="form-group">
                <label class="form-label">æ–‡ä»¶å¤¹åç§°</label>
                <input type="text" class="form-input" id="folderName" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°">
            </div>
            <div style="text-align: right;">
                <button class="btn" onclick="closeModal('newFolderModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createFolder()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- é‡å‘½åæ¨¡æ€æ¡† -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">é‡å‘½å</h3>
                <button class="modal-close" onclick="closeModal('renameModal')">âœ•</button>
            </div>
            <div class="form-group">
                <label class="form-label">æ–°åç§°</label>
                <input type="text" class="form-input" id="newName" placeholder="è¯·è¾“å…¥æ–°åç§°">
            </div>
            <div style="text-align: right;">
                <button class="btn" onclick="closeModal('renameModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="renameItem()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- å³é”®èœå• -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="downloadItem()">ğŸ“¥ ä¸‹è½½</div>
        <div class="context-menu-item" onclick="showRenameModal()">âœï¸ é‡å‘½å</div>
        <div class="context-menu-item" onclick="deleteItem()">ğŸ—‘ï¸ åˆ é™¤</div>
        <div class="context-menu-item" onclick="shareItem()">ğŸ”— åˆ†äº«</div>
    </div>

    <script>
        // æ–‡ä»¶ç³»ç»Ÿç®¡ç†
        class FileSystem {
            constructor() {
                this.files = this.loadFiles();
                this.currentPath = '/';
                this.currentView = 'all';
                this.viewMode = 'grid';
                this.selectedItems = new Set();
                this.maxStorage = 100 * 1024 * 1024; // 100MB
                this.contextFile = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.renderFiles();
                this.updateStorageInfo();
            }

            loadFiles() {
                const saved = localStorage.getItem('cloudFiles');
                return saved ? JSON.parse(saved) : this.getDefaultFiles();
            }

            getDefaultFiles() {
                return [
                    {
                        id: '1',
                        name: 'æ–‡æ¡£',
                        type: 'folder',
                        path: '/',
                        size: 0,
                        created: Date.now(),
                        modified: Date.now()
                    },
                    {
                        id: '2',
                        name: 'å›¾ç‰‡',
                        type: 'folder',
                        path: '/',
                        size: 0,
                        created: Date.now(),
                        modified: Date.now()
                    },
                    {
                        id: '3',
                        name: 'ç¤ºä¾‹æ–‡æ¡£.txt',
                        type: 'file',
                        path: '/',
                        size: 1024,
                        created: Date.now(),
                        modified: Date.now(),
                        content: 'è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡æ¡£æ–‡ä»¶ã€‚'
                    },
                    {
                        id: '4',
                        name: 'ç¤ºä¾‹å›¾ç‰‡.jpg',
                        type: 'image',
                        path: '/',
                        size: 2048,
                        created: Date.now(),
                        modified: Date.now()
                    }
                ];
            }

            saveFiles() {
                localStorage.setItem('cloudFiles', JSON.stringify(this.files));
            }

            setupEventListeners() {
                // æ‹–æ‹½ä¸Šä¼ 
                const uploadArea = document.getElementById('uploadArea');

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFileUpload(e.dataTransfer.files);
                });

                // ä¾§è¾¹æ å¯¼èˆª
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        this.currentView = item.dataset.view;
                        this.renderFiles();
                    });
                });

                // éšè—å³é”®èœå•
                document.addEventListener('click', () => {
                    document.getElementById('contextMenu').classList.remove('show');
                });

                // é”®ç›˜åˆ é™¤/æ¢å¤å¿«æ·é”®ï¼ˆDel åˆ é™¤ / Ctrl+Z æ¢å¤æœ€è¿‘ï¼‰
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Delete') {
                        // åˆ é™¤é€‰ä¸­
                        if (this.selectedItems.size) {
                            this.deleteItem(Array.from(this.selectedItems));
                        }
                    }
                });
            }

            renderFiles() {
                const files = this.getFilteredFiles();
                const gridContainer = document.getElementById('fileGrid');
                const listContainer = document.getElementById('fileList');

                if (this.viewMode === 'grid') {
                    gridContainer.style.display = 'grid';
                    listContainer.style.display = 'none';
                    this.renderGridView(files, gridContainer);
                } else {
                    gridContainer.style.display = 'none';
                    listContainer.style.display = 'block';
                    this.renderListView(files, listContainer);
                }

                this.updateBreadcrumb();
                this.updateStorageInfo();
            }

            getFilteredFiles() {
                let files;
                if (this.currentView === 'trash') {
                    files = this.files.filter(file => file.deleted);
                } else {
                    files = this.files.filter(file => file.path === this.currentPath && !file.deleted);
                    if (this.currentView !== 'all') {
                        const typeMap = {
                            'images': ['image'],
                            'documents': ['file', 'pdf', 'doc', 'txt'],
                            'videos': ['video'],
                            'music': ['audio'],
                            'others': ['other']
                        };

                        const types = typeMap[this.currentView] || [];
                        files = files.filter(file => types.includes(file.type));
                    }
                }

                return files;
            }

            renderGridView(files, container) {
                container.innerHTML = '';

                // è¿”å›ä¸Šçº§ç›®å½•
                if (this.currentPath !== '/') {
                    const backItem = this.createFileItem({
                        id: 'back',
                        name: '..',
                        type: 'back',
                        icon: 'â¬†ï¸'
                    });
                    container.appendChild(backItem);
                }

                files.forEach(file => {
                    const item = this.createFileItem(file);
                    container.appendChild(item);
                });
            }

            renderListView(files, container) {
                container.innerHTML = `
                    <div class="file-list-header">
                        <div></div>
                        <div>åç§°</div>
                        <div>å¤§å°</div>
                        <div>ä¿®æ”¹æ—¶é—´</div>
                        <div>æ“ä½œ</div>
                    </div>
                `;

                if (this.currentPath !== '/') {
                    const backItem = this.createListItem({
                        id: 'back',
                        name: '..',
                        type: 'back',
                        modified: Date.now()
                    });
                    container.appendChild(backItem);
                }

                files.forEach(file => {
                    const item = this.createListItem(file);
                    container.appendChild(item);
                });
            }

            createFileItem(file) {
                const div = document.createElement('div');
                div.className = 'file-item';
                if (this.selectedItems.has(String(file.id))) {
                    div.classList.add('selected');
                }

                const icon = this.getFileIcon(file);
                const size = this.formatFileSize(file.size);

                div.innerHTML = `
                    <input type="checkbox" class="file-checkbox" ${this.selectedItems.has(String(file.id)) ? 'checked' : ''}>
                    <div class="file-icon">${icon}</div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${size}</div>
                `;

                div.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        this.handleFileClick(file);
                    }
                });

                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e, file);
                });

                const checkbox = div.querySelector('.file-checkbox');
                checkbox.addEventListener('change', (e) => {
                    const idStr = String(file.id);
                    if (e.target.checked) {
                        this.selectedItems.add(idStr);
                    } else {
                        this.selectedItems.delete(idStr);
                    }
                    div.classList.toggle('selected');
                });

                return div;
            }

            createListItem(file) {
                const div = document.createElement('div');
                div.className = 'file-list-item';
                if (this.selectedItems.has(String(file.id))) {
                    div.classList.add('selected');
                }

                const icon = this.getFileIcon(file);
                const size = this.formatFileSize(file.size);
                const date = new Date(file.modified).toLocaleDateString();

                div.innerHTML = `
                    <input type="checkbox" class="file-checkbox" ${this.selectedItems.has(String(file.id)) ? 'checked' : ''}>
                    <div>${icon} ${file.name}</div>
                    <div>${size}</div>
                    <div>${date}</div>
                    <div>
                        <button class="btn" onclick="fileSystem.downloadItem('${file.id}')">ä¸‹è½½</button>
                        <button class="btn" onclick="fileSystem.deleteItem('${file.id}')">åˆ é™¤</button>
                    </div>
                `;

                const checkbox = div.querySelector('.file-checkbox');
                checkbox.addEventListener('change', (e) => {
                    const idStr = String(file.id);
                    if (e.target.checked) {
                        this.selectedItems.add(idStr);
                    } else {
                        this.selectedItems.delete(idStr);
                    }
                    div.classList.toggle('selected');
                });

                return div;
            }

            getFileIcon(file) {
                const icons = {
                    'folder': 'ğŸ“',
                    'back': 'â¬†ï¸',
                    'image': 'ğŸ–¼ï¸',
                    'video': 'ğŸ¥',
                    'audio': 'ğŸµ',
                    'pdf': 'ğŸ“•',
                    'doc': 'ğŸ“˜',
                    'txt': 'ğŸ“„',
                    'zip': 'ğŸ“¦',
                    'file': 'ğŸ“„'
                };
                return icons[file.type] || icons['file'];
            }

            formatFileSize(bytes) {
                if (!bytes) return '-';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            handleFileClick(file) {
                if (file.type === 'folder') {
                    this.navigateToFolder(file.path + file.name + '/');
                } else if (file.type === 'back') {
                    this.navigateToParent();
                } else {
                    this.previewFile && this.previewFile(file);
                }
            }

            navigateToFolder(path) {
                this.currentPath = path;
                this.selectedItems.clear();
                this.renderFiles();
            }

            navigateToParent() {
                const parts = this.currentPath.split('/').filter(p => p);
                parts.pop();
                this.currentPath = '/' + parts.join('/') + '/';
                if (this.currentPath === '//') this.currentPath = '/';
                this.selectedItems.clear();
                this.renderFiles();
            }

            // ä¸Šä¼ æ—¶ï¼šè‡ªåŠ¨è§£å†³åç§°å†²çªï¼ˆæ·»åŠ  (1)ã€(2)...ï¼‰
            getAvailableName(name, path) {
                const dotIndex = name.lastIndexOf('.');
                const base = dotIndex === -1 ? name : name.slice(0, dotIndex);
                const ext = dotIndex === -1 ? '' : name.slice(dotIndex);
                let candidate = name;
                let i = 1;
                while (this.files.some(f => f.path === path && f.name === candidate && !f.deleted)) {
                    candidate = `${base} (${i})${ext}`;
                    i++;
                }
                return candidate;
            }

            handleFileUpload(files) {
                Array.from(files).forEach(file => {
                    if (file.size > 1024 * 1024 * 1024) {
                        alert(`æ–‡ä»¶ ${file.name} è¶…è¿‡1GBé™åˆ¶`);
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // å¤„ç†åŒåï¼šå¦‚æœå›æ”¶ç«™å·²å­˜åœ¨åŒåé¡¹ï¼Œæç¤ºæ¢å¤æˆ–é‡å‘½å
                        const deletedSame = this.files.find(f => f.path === this.currentPath && f.name === file.name && f.deleted);
                        if (deletedSame) {
                            if (confirm(`å›æ”¶ç«™ä¸­å­˜åœ¨åŒåæ–‡ä»¶ "${file.name}"ï¼Œæ˜¯å¦æ¢å¤å¹¶è¦†ç›–ï¼Ÿé€‰æ‹©â€œå¦â€å°†è‡ªåŠ¨é‡å‘½åä¸Šä¼ æ–‡ä»¶ã€‚`)) {
                                deletedSame.deleted = false;
                                deletedSame.deletedAt = undefined;
                                deletedSame.content = e.target.result;
                                deletedSame.size = file.size;
                                deletedSame.modified = Date.now();
                                this.saveFiles();
                                this.renderFiles();
                                this.updateStorageInfo();
                                return;
                            }
                        }

                        const uniqueName = this.getAvailableName(file.name, this.currentPath);

                        const fileData = {
                            id: Date.now().toString() + Math.floor(Math.random() * 10000).toString(),
                            name: uniqueName,
                            type: this.getFileType(file.name),
                            path: this.currentPath,
                            size: file.size,
                            created: Date.now(),
                            modified: Date.now(),
                            content: e.target.result
                        };

                        this.files.push(fileData);
                        this.saveFiles();
                        this.renderFiles();
                        this.updateStorageInfo();
                    };
                    reader.readAsDataURL(file);
                });
            }

            getFileType(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const types = {
                    'jpg': 'image', 'jpeg': 'image', 'png': 'image', 'gif': 'image',
                    'mp4': 'video', 'avi': 'video', 'mov': 'video',
                    'mp3': 'audio', 'wav': 'audio', 'flac': 'audio',
                    'pdf': 'pdf', 'doc': 'doc', 'docx': 'doc',
                    'txt': 'txt', 'zip': 'zip', 'rar': 'zip'
                };
                return types[ext] || 'file';
            }

            // æ–°å»ºæ–‡ä»¶å¤¹ï¼šé‡å¤æ ¡éªŒï¼Œå›æ”¶ç«™æ¢å¤æç¤º
            createFolder(nameArg) {
                const name = nameArg || document.getElementById('folderName').value.trim();
                if (!name) {
                    alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°');
                    return;
                }

                const exists = this.files.find(f => f.path === this.currentPath && f.name === name && !f.deleted && f.type === 'folder');
                if (exists) {
                    alert('å½“å‰ç›®å½•å·²å­˜åœ¨åŒåæ–‡ä»¶å¤¹');
                    return;
                }

                const deletedSame = this.files.find(f => f.path === this.currentPath && f.name === name && f.deleted && f.type === 'folder');
                if (deletedSame) {
                    if (confirm(`å›æ”¶ç«™ä¸­å­˜åœ¨åŒåæ–‡ä»¶å¤¹ "${name}"ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ`)) {
                        deletedSame.deleted = false;
                        deletedSame.deletedAt = undefined;
                        deletedSame.modified = Date.now();
                        this.saveFiles();
                        this.renderFiles();
                        closeModal('newFolderModal');
                        document.getElementById('folderName').value = '';
                        return;
                    }
                }

                const folder = {
                    id: Date.now().toString() + Math.floor(Math.random() * 10000).toString(),
                    name: name,
                    type: 'folder',
                    path: this.currentPath,
                    size: 0,
                    created: Date.now(),
                    modified: Date.now()
                };

                this.files.push(folder);
                this.saveFiles();
                this.renderFiles();
                closeModal('newFolderModal');
                document.getElementById('folderName').value = '';
            }

            // åˆ é™¤ï¼šæ”¯æŒæ‰¹é‡ã€ç§»åŠ¨åˆ°å›æ”¶ç«™ä¸åœ¨å›æ”¶ç«™ä¸­æ°¸ä¹…åˆ é™¤
            deleteItem(id) {
                // æ¥å—å•ä¸ª idã€æ•°ç»„æˆ–æ— å‚æ•°ï¼ˆä½¿ç”¨ selectedItemsï¼‰
                let ids;
                if (!id) {
                    if (this.selectedItems.size === 0) {
                        alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶');
                        return;
                    }
                    ids = Array.from(this.selectedItems);
                } else if (Array.isArray(id)) {
                    ids = id;
                } else {
                    ids = [id];
                }

                // å°†å­—ç¬¦ä¸² id ç»Ÿä¸€
                ids = ids.map(i => String(i));

                // åˆ¤æ–­ï¼šå¦‚æœå½“å‰è§†å›¾æ˜¯å›æ”¶ç«™æˆ–ç›®æ ‡é¡¹å·²åœ¨å›æ”¶ç«™ -> æ°¸ä¹…åˆ é™¤
                const toPermanently = this.currentView === 'trash';

                if (!toPermanently) {
                    if (!confirm('ç¡®å®šè¦å°†é€‰ä¸­é¡¹ç§»å…¥å›æ”¶ç«™å—ï¼Ÿ')) return;
                    ids.forEach(fileId => {
                        const file = this.files.find(f => String(f.id) === String(fileId));
                        if (file) {
                            file.deleted = true;
                            file.deletedAt = Date.now();
                        }
                    });
                } else {
                    if (!confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤é€‰ä¸­é¡¹ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
                    this.files = this.files.filter(f => !ids.includes(String(f.id)));
                }

                this.saveFiles();
                this.renderFiles();
                this.updateStorageInfo();
                this.selectedItems.clear();
            }

            // æ¢å¤ï¼ˆä»å›æ”¶ç«™ï¼‰
            restoreItem(id) {
                let ids;
                if (!id) {
                    if (this.selectedItems.size === 0) {
                        alert('è¯·é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶');
                        return;
                    }
                    ids = Array.from(this.selectedItems);
                } else if (Array.isArray(id)) {
                    ids = id;
                } else {
                    ids = [id];
                }

                ids = ids.map(i => String(i));
                ids.forEach(fileId => {
                    const file = this.files.find(f => String(f.id) === String(fileId));
                    if (file && file.deleted) {
                        file.deleted = false;
                        file.deletedAt = undefined;
                        file.modified = Date.now();
                    }
                });

                this.saveFiles();
                this.renderFiles();
                this.updateStorageInfo();
                this.selectedItems.clear();
            }

            // ä¸‹è½½
            downloadItem(id) {
                const file = this.files.find(f => String(f.id) === String(id));
                if (!file) return;

                if (file.type === 'folder') {
                    alert('æš‚ä¸æ”¯æŒä¸‹è½½æ–‡ä»¶å¤¹');
                    return;
                }

                if (!file.content) {
                    alert('æ­¤æ–‡ä»¶æ²¡æœ‰å¯ä¸‹è½½å†…å®¹');
                    return;
                }

                const link = document.createElement('a');
                link.href = file.content;
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                link.remove();
            }

            // å³é”®èœå•åŠ¨æ€ç”Ÿæˆï¼ˆæ ¹æ®æ˜¯å¦åœ¨å›æ”¶ç«™æ˜¾ç¤ºä¸åŒæ“ä½œï¼‰
            showContextMenu(e, file) {
                const menu = document.getElementById('contextMenu');
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.classList.add('show');

                this.contextFile = file;

                // åŠ¨æ€ç”Ÿæˆèœå•é¡¹ï¼Œé˜²æ­¢ä¸é™æ€ onclick å†²çª
                let html = '';
                if (!file.deleted) {
                    if (file.type !== 'folder') {
                        html += `<div class="context-menu-item" onclick="fileSystem.downloadItem('${file.id}')">ğŸ“¥ ä¸‹è½½</div>`;
                    }
                    html += `<div class="context-menu-item" onclick="showRenameModal()">âœï¸ é‡å‘½å</div>`;
                    html += `<div class="context-menu-item" onclick="fileSystem.deleteItem('${file.id}')">ğŸ—‘ï¸ åˆ é™¤</div>`;
                    html += `<div class="context-menu-item" onclick="shareItem()">ğŸ”— åˆ†äº«</div>`;
                } else {
                    // åœ¨å›æ”¶ç«™ä¸­çš„é¡¹
                    html += `<div class="context-menu-item" onclick="fileSystem.restoreItem('${file.id}')">â™»ï¸ æ¢å¤</div>`;
                    html += `<div class="context-menu-item" onclick="fileSystem.deleteItem('${file.id}')">âš ï¸ æ°¸ä¹…åˆ é™¤</div>`;
                }

                menu.innerHTML = html;
            }

            updateStorageInfo() {
                const used = this.files.filter(f => !f.deleted).reduce((sum, file) => sum + (file.size || 0), 0);
                const percentage = Math.min(100, (used / this.maxStorage) * 100);

                document.getElementById('storageFill').style.width = percentage + '%';
                document.getElementById('storageText').textContent =
                    `${this.formatFileSize(used)} / ${this.formatFileSize(this.maxStorage)}`;
            }

            updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                const parts = this.currentPath.split('/').filter(p => p);

                let html = '<span class="breadcrumb-item" onclick="fileSystem.navigateToFolder(\'/\')">æ ¹ç›®å½•</span>';

                let path = '';
                parts.forEach((part, index) => {
                    path += '/' + part;
                    html += '<span class="breadcrumb-separator">/</span>';
                    html += `<span class="breadcrumb-item" onclick="fileSystem.navigateToFolder('${path}/')">${part}</span>`;
                });

                breadcrumb.innerHTML = html;
            }

            searchFiles(query) {
                if (!query) {
                    this.renderFiles();
                    return;
                }

                const results = this.files.filter(file =>
                    file.name.toLowerCase().includes(query.toLowerCase()) &&
                    !file.deleted
                );

                const gridContainer = document.getElementById('fileGrid');
                const listContainer = document.getElementById('fileList');

                if (this.viewMode === 'grid') {
                    this.renderGridView(results, gridContainer);
                } else {
                    this.renderListView(results, listContainer);
                }
            }

            toggleView() {
                this.viewMode = this.viewMode === 'grid' ? 'list' : 'grid';
                document.getElementById('viewIcon').textContent =
                    this.viewMode === 'grid' ? 'ğŸ“‹' : 'ğŸ“±';
                this.renderFiles();
            }

            // é‡å‘½åï¼ˆç±»å†…æ–¹æ³•ï¼Œå¸¦é‡å¤åæ ¡éªŒï¼‰
            renameItem(id, newName) {
                if (!id || !newName) return false;
                const file = this.files.find(f => String(f.id) === String(id));
                if (!file) return false;

                const conflict = this.files.find(f => f.path === file.path && f.name === newName && String(f.id) !== String(id) && !f.deleted);
                if (conflict) {
                    alert('åŒè·¯å¾„ä¸‹å·²å­˜åœ¨åŒåæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹');
                    return false;
                }

                const deletedSame = this.files.find(f => f.path === file.path && f.name === newName && f.deleted);
                if (deletedSame) {
                    if (!confirm(`å›æ”¶ç«™ä¸­å­˜åœ¨åŒåé¡¹ "${newName}"ï¼Œæ˜¯å¦ç»§ç»­å¹¶å¯¼è‡´åŒåå†²çªï¼Ÿ`)) {
                        return false;
                    }
                }

                file.name = newName;
                file.modified = Date.now();
                this.saveFiles();
                this.renderFiles();
                return true;
            }
        }

        // åˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿ
        const fileSystem = new FileSystem();

        // å…¨å±€å‡½æ•°
        function showNewFolderModal() {
            document.getElementById('newFolderModal').classList.add('show');
        }

        function showRenameModal() {
            // å¦‚æœæœ‰é€‰ä¸­çš„å•ä¸ªé¡¹ä¸”æ²¡æœ‰ä¸Šä¸‹æ–‡æ–‡ä»¶ï¼Œåˆ™ä½¿ç”¨å…¶è¿›è¡Œé‡å‘½å
            if (!fileSystem.contextFile) {
                if (fileSystem.selectedItems.size === 1) {
                    const id = Array.from(fileSystem.selectedItems)[0];
                    const f = fileSystem.files.find(ff => String(ff.id) === String(id));
                    if (f) fileSystem.contextFile = f;
                }
            }

            if (fileSystem.contextFile) {
                document.getElementById('newName').value = fileSystem.contextFile.name;
                document.getElementById('renameModal').classList.add('show');
            } else {
                alert('è¯·é€‰æ‹©è¦é‡å‘½åçš„æ–‡ä»¶æˆ–å³é”®ç‚¹å‡»ç›®æ ‡æ–‡ä»¶');
            }
        }

        function createFolder() {
            fileSystem.createFolder();
        }

        function renameItem() {
            const newName = document.getElementById('newName').value.trim();
            if (!newName || !fileSystem.contextFile) return;
            const success = fileSystem.renameItem(fileSystem.contextFile.id, newName);
            if (success) {
                fileSystem.contextFile = null;
                closeModal('renameModal');
            }
        }

        function deleteItem() {
            // å¦‚æœé€šè¿‡å³é”®è°ƒç”¨ï¼ŒcontextFile å­˜åœ¨
            if (fileSystem.contextFile) {
                fileSystem.deleteItem(fileSystem.contextFile.id);
                fileSystem.contextFile = null;
                return;
            }
            // å¦åˆ™åˆ é™¤é€‰ä¸­é¡¹
            fileSystem.deleteItem();
        }

        function downloadItem() {
            if (fileSystem.contextFile) {
                fileSystem.downloadItem(fileSystem.contextFile.id);
            } else {
                alert('è¯·é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶');
            }
        }

        function shareItem() {
            if (fileSystem.contextFile) {
                const url = window.location.href.split('#')[0] + '#share=' + fileSystem.contextFile.id;
                navigator.clipboard.writeText(url);
                alert('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } else {
                alert('è¯·é€‰æ‹©è¦åˆ†äº«çš„æ–‡ä»¶');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function handleFileUpload(event) {
            // æ”¯æŒç›´æ¥ä¼  FileList æˆ– input event
            if (event && event.target && event.target.files) {
                fileSystem.handleFileUpload(event.target.files);
            } else {
                fileSystem.handleFileUpload(event);
            }
        }

        function searchFiles(query) {
            fileSystem.searchFiles(query);
        }

        function toggleView() {
            fileSystem.toggleView();
        }

        function navigateToPath(path) {
            fileSystem.navigateToFolder(path);
        }
    </script>

    <!-- é¡µè„š -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 CBZ Labs. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>
