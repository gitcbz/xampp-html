<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–¹å—ä¸–ç•Œ - Block World</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8C8 100%);
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            cursor: crosshair;
        }

        /* UIç•Œé¢ */
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .top-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            display: flex;
            gap: 30px;
            font-size: 16px;
            pointer-events: auto;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-icon {
            font-size: 20px;
        }

        /* åº“å­˜æ  */
        .inventory {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }

        .inventory-slot {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 30px;
        }

        .inventory-slot:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .inventory-slot.active {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .slot-number {
            position: absolute;
            top: 2px;
            left: 5px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* æ§åˆ¶æç¤º */
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            font-size: 14px;
            line-height: 1.8;
            max-width: 250px;
            pointer-events: auto;
        }

        .controls h3 {
            margin-bottom: 10px;
            color: #ffd700;
            font-size: 18px;
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .control-key {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* å¼€å§‹èœå• */
        .start-menu {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .menu-content {
            text-align: center;
            color: white;
        }

        .game-title {
            font-size: 64px;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 210, 255, 0.5);
        }

        .game-subtitle {
            font-size: 20px;
            color: #aaa;
            margin-bottom: 40px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
            pointer-events: auto;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 210, 255, 0.5);
        }

        /* åå­—å‡†æ˜Ÿ */
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
        }

        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        }

        .crosshair::before {
            width: 2px;
            height: 20px;
            left: 9px;
            top: 0;
        }

        .crosshair::after {
            width: 20px;
            height: 2px;
            left: 0;
            top: 9px;
        }

        /* æ¶ˆæ¯æç¤º */
        .message {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .message.show {
            opacity: 1;
        }

        /* è¿”å›æŒ‰é’® */
        .back-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            font-size: 16px;
            pointer-events: auto;
            z-index: 1000;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* æ—¶é—´æ˜¾ç¤º */
        .time-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            font-size: 16px;
            pointer-events: auto;
        }

        .sun-icon, .moon-icon {
            margin-right: 8px;
            font-size: 20px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .controls {
                display: none;
            }
            
            .inventory {
                bottom: 20px;
            }
            
            .inventory-slot {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            .game-title {
                font-size: 48px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div class="game-ui">
            <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
            <div class="top-bar">
                <div class="info-item">
                    <span class="info-icon">ğŸ“</span>
                    <span>ä½ç½®: <span id="position">0, 0, 0</span></span>
                </div>
                <div class="info-item">
                    <span class="info-icon">ğŸ¯</span>
                    <span>æ–¹å—: <span id="blockCount">0</span></span>
                </div>
                <div class="info-item">
                    <span class="info-icon">âš¡</span>
                    <span>FPS: <span id="fps">60</span></span>
                </div>
            </div>

            <!-- æ—¶é—´æ˜¾ç¤º -->
            <div class="time-display">
                <span id="timeIcon" class="sun-icon">â˜€ï¸</span>
                <span id="timeText">ç™½å¤©</span>
            </div>

            <!-- æ§åˆ¶æç¤º -->
            <div class="controls">
                <h3>æ“ä½œè¯´æ˜</h3>
                <div class="control-item">
                    <span>ç§»åŠ¨</span>
                    <span class="control-key">WASD</span>
                </div>
                <div class="control-item">
                    <span>è·³è·ƒ</span>
                    <span class="control-key">ç©ºæ ¼</span>
                </div>
                <div class="control-item">
                    <span>è§†è§’</span>
                    <span class="control-key">é¼ æ ‡</span>
                </div>
                <div class="control-item">
                    <span>æ”¾ç½®æ–¹å—</span>
                    <span class="control-key">å·¦é”®</span>
                </div>
                <div class="control-item">
                    <span>ç ´åæ–¹å—</span>
                    <span class="control-key">å³é”®</span>
                </div>
                <div class="control-item">
                    <span>é£è¡Œ</span>
                    <span class="control-key">F</span>
                </div>
                <div class="control-item">
                    <span>åˆ‡æ¢æ–¹å—</span>
                    <span class="control-key">1-9</span>
                </div>
            </div>

            <!-- åº“å­˜æ  -->
            <div class="inventory">
                <div class="inventory-slot active" data-block="grass">
                    <span class="slot-number">1</span>
                    ğŸŒ±
                </div>
                <div class="inventory-slot" data-block="dirt">
                    <span class="slot-number">2</span>
                    ğŸŸ«
                </div>
                <div class="inventory-slot" data-block="stone">
                    <span class="slot-number">3</span>
                    ğŸª¨
                </div>
                <div class="inventory-slot" data-block="wood">
                    <span class="slot-number">4</span>
                    ğŸªµ
                </div>
                <div class="inventory-slot" data-block="leaves">
                    <span class="slot-number">5</span>
                    ğŸƒ
                </div>
                <div class="inventory-slot" data-block="water">
                    <span class="slot-number">6</span>
                    ğŸ’§
                </div>
                <div class="inventory-slot" data-block="sand">
                    <span class="slot-number">7</span>
                    ğŸ–ï¸
                </div>
                <div class="inventory-slot" data-block="brick">
                    <span class="slot-number">8</span>
                    ğŸ§±
                </div>
                <div class="inventory-slot" data-block="glass">
                    <span class="slot-number">9</span>
                    ğŸªŸ
                </div>
            </div>

            <!-- åå­—å‡†æ˜Ÿ -->
            <div class="crosshair"></div>

            <!-- æ¶ˆæ¯æç¤º -->
            <div class="message" id="message"></div>
        </div>

        <!-- å¼€å§‹èœå• -->
        <div class="start-menu" id="startMenu">
            <div class="menu-content">
                <h1 class="game-title">ğŸŒ æ–¹å—ä¸–ç•Œ</h1>
                <p class="game-subtitle">åˆ›é€ å±äºä½ çš„ä¸–ç•Œ</p>
                <button class="btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
                <div style="margin-top: 30px; color: #aaa;">
                    <p>æç¤ºï¼šæŒ‰ ESC æš‚åœæ¸¸æˆ</p>
                </div>
            </div>
        </div>

        <!-- è¿”å›æŒ‰é’® -->
        <a href="../index.html" class="back-btn">â† è¿”å›æ¸¸æˆä¸­å¿ƒ</a>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // è®¾ç½®ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // æ¸¸æˆçŠ¶æ€
        const game = {
            world: {},
            blockSize: 20,
            worldSize: 50,
            camera: { x: 0, y: 0, z: 0 },
            player: {
                x: 25,
                y: 10,
                z: 25,
                vx: 0,
                vy: 0,
                vz: 0,
                speed: 0.2,
                jumpPower: 0.3,
                onGround: false,
                flying: false
            },
            selectedBlock: 'grass',
            mouse: { x: 0, y: 0 },
            keys: {},
            isPaused: false,
            isStarted: false,
            time: 0,
            dayDuration: 600, // 10ç§’ä¸€å¤©
            blockCount: 0,
            fps: 60,
            lastFrameTime: performance.now()
        };

        // æ–¹å—ç±»å‹
        const blockTypes = {
            grass: { color: '#7CFC00', icon: 'ğŸŒ±', solid: true },
            dirt: { color: '#8B4513', icon: 'ğŸŸ«', solid: true },
            stone: { color: '#808080', icon: 'ğŸª¨', solid: true },
            wood: { color: '#8B4513', icon: 'ğŸªµ', solid: true },
            leaves: { color: '#228B22', icon: 'ğŸƒ', solid: false },
            water: { color: '#4682B4', icon: 'ğŸ’§', solid: false },
            sand: { color: '#F4A460', icon: 'ğŸ–ï¸', solid: true },
            brick: { color: '#B22222', icon: 'ğŸ§±', solid: true },
            glass: { color: '#87CEEB', icon: 'ğŸªŸ', solid: true }
        };

        // åˆå§‹åŒ–ä¸–ç•Œ
        function initWorld() {
            // ç”Ÿæˆåœ°å½¢
            for (let x = 0; x < game.worldSize; x++) {
                for (let z = 0; z < game.worldSize; z++) {
                    const height = Math.floor(Math.sin(x * 0.1) * 3 + Math.cos(z * 0.1) * 3 + 5);
                    
                    for (let y = 0; y <= height; y++) {
                        let blockType = 'stone';
                        if (y === height) {
                            blockType = 'grass';
                        } else if (y > height - 3) {
                            blockType = 'dirt';
                        }
                        
                        setBlock(x, y, z, blockType);
                    }
                    
                    // æ·»åŠ ä¸€äº›æ ‘
                    if (Math.random() < 0.02 && height > 3) {
                        generateTree(x, height + 1, z);
                    }
                }
            }
        }

        // ç”Ÿæˆæ ‘
        function generateTree(x, y, z) {
            // æ ‘å¹²
            for (let i = 0; i < 4; i++) {
                setBlock(x, y + i, z, 'wood');
            }
            
            // æ ‘å¶
            for (let dx = -2; dx <= 2; dx++) {
                for (let dy = 2; dy <= 4; dy++) {
                    for (let dz = -2; dz <= 2; dz++) {
                        if (Math.abs(dx) + Math.abs(dz) <= 3) {
                            setBlock(x + dx, y + dy, z + dz, 'leaves');
                        }
                    }
                }
            }
        }

        // è®¾ç½®æ–¹å—
        function setBlock(x, y, z, type) {
            const key = `${x},${y},${z}`;
            if (type) {
                game.world[key] = type;
                game.blockCount++;
            } else {
                delete game.world[key];
                game.blockCount--;
            }
        }

        // è·å–æ–¹å—
        function getBlock(x, y, z) {
            const key = `${x},${y},${z}`;
            return game.world[key];
        }

        // 3Dåˆ°2DæŠ•å½±
        function project3D(x, y, z) {
            const scale = game.blockSize;
            const isoX = (x - z) * scale * 0.866;
            const isoY = (x + z) * scale * 0.5 - y * scale;
            
            return {
                x: isoX + canvas.width / 2 - game.camera.x,
                y: isoY + canvas.height / 2 - game.camera.y
            };
        }

        // ç»˜åˆ¶æ–¹å—
        function drawBlock(x, y, z, type) {
            const block = blockTypes[type];
            if (!block) return;
            
            const pos = project3D(x, y, z);
            const size = game.blockSize;
            
            // è®¡ç®—æ–¹å—çš„å„ä¸ªé¢
            const top = [
                { x: pos.x, y: pos.y },
                { x: pos.x + size * 0.866, y: pos.y + size * 0.5 },
                { x: pos.x, y: pos.y + size },
                { x: pos.x - size * 0.866, y: pos.y + size * 0.5 }
            ];
            
            const left = [
                { x: top[3].x, y: top[3].y },
                { x: top[2].x, y: top[2].y },
                { x: top[2].x, y: top[2].y + size },
                { x: top[3].x, y: top[3].y + size }
            ];
            
            const right = [
                { x: top[2].x, y: top[2].y },
                { x: top[1].x, y: top[1].y },
                { x: top[1].x, y: top[1].y + size },
                { x: top[2].x, y: top[2].y + size }
            ];
            
            // ç»˜åˆ¶é˜´å½±
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.beginPath();
            ctx.moveTo(left[0].x, left[0].y + size);
            ctx.lineTo(left[1].x, left[1].y + size);
            ctx.lineTo(right[1].x, right[1].y + size);
            ctx.lineTo(right[0].x, right[0].y + size);
            ctx.closePath();
            ctx.fill();
            
            // ç»˜åˆ¶å„ä¸ªé¢
            // å·¦é¢
            ctx.fillStyle = shadeColor(block.color, -20);
            ctx.beginPath();
            ctx.moveTo(left[0].x, left[0].y);
            ctx.lineTo(left[1].x, left[1].y);
            ctx.lineTo(left[2].x, left[2].y);
            ctx.lineTo(left[3].x, left[3].y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // å³é¢
            ctx.fillStyle = shadeColor(block.color, 20);
            ctx.beginPath();
            ctx.moveTo(right[0].x, right[0].y);
            ctx.lineTo(right[1].x, right[1].y);
            ctx.lineTo(right[2].x, right[2].y);
            ctx.lineTo(right[3].x, right[3].y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // é¡¶é¢
            ctx.fillStyle = block.color;
            ctx.beginPath();
            ctx.moveTo(top[0].x, top[0].y);
            ctx.lineTo(top[1].x, top[1].y);
            ctx.lineTo(top[2].x, top[2].y);
            ctx.lineTo(top[3].x, top[3].y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }

        // é¢œè‰²æ˜æš—è°ƒæ•´
        function shadeColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        // è·å–ç›®æ ‡æ–¹å—
        function getTargetBlock() {
            const maxDistance = 5;
            let closestBlock = null;
            let closestDistance = maxDistance;
            
            for (let key in game.world) {
                const [x, y, z] = key.split(',').map(Number);
                const distance = Math.sqrt(
                    Math.pow(x - game.player.x, 2) +
                    Math.pow(y - game.player.y, 2) +
                    Math.pow(z - game.player.z, 2)
                );
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestBlock = { x, y, z, type: game.world[key] };
                }
            }
            
            return closestBlock;
        }

        // æ›´æ–°ç©å®¶
        function updatePlayer() {
            if (game.isPaused) return;
            
            const player = game.player;
            
            // ç§»åŠ¨
            // ä½¿ç”¨ KeyboardEvent.code (KeyW/KeyA/KeyS/KeyD) æ¥ä¿è¯å¤§å°å†™å’Œå¸ƒå±€ä¸€è‡´æ€§
            if (game.keys['KeyW']) {
                player.vz -= player.speed;
            }
            if (game.keys['KeyS']) {
                player.vz += player.speed;
            }
            if (game.keys['KeyA']) {
                player.vx -= player.speed;
            }
            if (game.keys['KeyD']) {
                player.vx += player.speed;
            }
            
            // è·³è·ƒ
            // ä½¿ç”¨ code åç§°ï¼šSpace / ArrowUp
            if ((game.keys['Space'] || game.keys['ArrowUp']) && (player.onGround || player.flying)) {
                player.vy = -player.jumpPower;
            }
            
            // é£è¡Œæ¨¡å¼çš„åˆ‡æ¢æ”¹ä¸ºåœ¨ keyup æ—¶è§¦å‘ï¼ˆé¿å…æŒ‰ä½é‡å¤è§¦å‘ï¼‰
            // ç›¸å…³é€»è¾‘åœ¨é”®ç›˜äº‹ä»¶éƒ¨åˆ†å®ç°
            
            // åº”ç”¨é‡åŠ›
            if (!player.flying) {
                player.vy += 0.02;
            }
            
            // åº”ç”¨é€Ÿåº¦
            player.x += player.vx;
            player.y += player.vy;
            player.z += player.vz;
            
            // æ‘©æ“¦åŠ›
            player.vx *= 0.8;
            player.vy *= 0.9;
            player.vz *= 0.8;
            
            // ç¢°æ’æ£€æµ‹
            const blockX = Math.floor(player.x);
            const blockY = Math.floor(player.y);
            const blockZ = Math.floor(player.z);
            
            player.onGround = false;
            
            // åœ°é¢æ£€æµ‹
            if (getBlock(blockX, blockY + 1, blockZ)) {
                player.y = blockY;
                player.vy = 0;
                player.onGround = true;
            }
            
            // è¾¹ç•Œé™åˆ¶
            player.x = Math.max(0, Math.min(game.worldSize - 1, player.x));
            player.y = Math.max(0, Math.min(20, player.y));
            player.z = Math.max(0, Math.min(game.worldSize - 1, player.z));
            
            // æ›´æ–°ç›¸æœº
            game.camera.x = (player.x - player.z) * game.blockSize * 0.866;
            game.camera.y = (player.x + player.z) * game.blockSize * 0.5 - player.y * game.blockSize;
        }

        // æ¸²æŸ“ä¸–ç•Œ
        function render() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å¤©ç©ºæ¸å˜
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            const isDay = (game.time % game.dayDuration) < (game.dayDuration / 2);
            
            if (isDay) {
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#98D8C8');
            } else {
                gradient.addColorStop(0, '#191970');
                gradient.addColorStop(1, '#000033');
            }
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å¤ªé˜³æˆ–æœˆäº®
            const celestialY = canvas.height / 2 - Math.cos((game.time % game.dayDuration) / game.dayDuration * Math.PI * 2) * 200;
            const celestialX = canvas.width / 2 + Math.sin((game.time % game.dayDuration) / game.dayDuration * Math.PI * 2) * 300;
            
            if (isDay) {
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(celestialX, celestialY, 30, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.fillStyle = '#F0F0F0';
                ctx.beginPath();
                ctx.arc(celestialX, celestialY, 25, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // æ”¶é›†æ‰€æœ‰æ–¹å—å¹¶æ’åºï¼ˆä»è¿œåˆ°è¿‘ï¼‰
            const blocks = [];
            for (let key in game.world) {
                const [x, y, z] = key.split(',').map(Number);
                blocks.push({ x, y, z, type: game.world[key] });
            }
            
            blocks.sort((a, b) => {
                const distA = a.x + a.z;
                const distB = b.x + b.z;
                return distA - distB;
            });
            
            // ç»˜åˆ¶æ–¹å—
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.lineWidth = 1;
            
            blocks.forEach(block => {
                drawBlock(block.x, block.y, block.z, block.type);
            });
            
            // ç»˜åˆ¶ç©å®¶
            const playerPos = project3D(game.player.x, game.player.y, game.player.z);
            ctx.fillStyle = '#FF6B6B';
            ctx.fillRect(playerPos.x - 5, playerPos.y - 15, 10, 20);
            ctx.fillStyle = '#FDBCB4';
            ctx.fillRect(playerPos.x - 4, playerPos.y - 10, 8, 8);
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.classList.add('show');
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 2000);
        }

        // æ›´æ–°UI
        function updateUI() {
            // æ›´æ–°ä½ç½®
            document.getElementById('position').textContent = 
                `${Math.floor(game.player.x)}, ${Math.floor(game.player.y)}, ${Math.floor(game.player.z)}`;
            
            // æ›´æ–°æ–¹å—æ•°é‡
            document.getElementById('blockCount').textContent = game.blockCount;
            
            // æ›´æ–°FPS
            document.getElementById('fps').textContent = Math.round(game.fps);
            
            // æ›´æ–°æ—¶é—´
            const isDay = (game.time % game.dayDuration) < (game.dayDuration / 2);
            const timeIcon = document.getElementById('timeIcon');
            const timeText = document.getElementById('timeText');
            
            if (isDay) {
                timeIcon.className = 'sun-icon';
                timeIcon.textContent = 'â˜€ï¸';
                timeText.textContent = 'ç™½å¤©';
            } else {
                timeIcon.className = 'moon-icon';
                timeIcon.textContent = 'ğŸŒ™';
                timeText.textContent = 'å¤œæ™š';
            }
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop(currentTime) {
            // è®¡ç®—FPS
            const deltaTime = currentTime - game.lastFrameTime;
            game.fps = 1000 / deltaTime;
            game.lastFrameTime = currentTime;
            
            if (!game.isPaused && game.isStarted) {
                // æ›´æ–°æ¸¸æˆæ—¶é—´
                game.time++;
                
                // æ›´æ–°ç©å®¶
                updatePlayer();
                
                // æ›´æ–°UI
                updateUI();
            }
            
            // æ¸²æŸ“
            render();
            
            requestAnimationFrame(gameLoop);
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            document.getElementById('startMenu').style.display = 'none';
            game.isStarted = true;
            game.isPaused = false;
            initWorld();
            showMessage('æ¬¢è¿æ¥åˆ°æ–¹å—ä¸–ç•Œï¼');
        }

        // æš‚åœæ¸¸æˆ
        function togglePause() {
            if (!game.isStarted) return;
            
            game.isPaused = !game.isPaused;
            if (game.isPaused) {
                document.getElementById('startMenu').style.display = 'flex';
                document.querySelector('.game-title').textContent = 'æ¸¸æˆæš‚åœ';
                document.querySelector('.game-subtitle').textContent = 'æŒ‰ ESC ç»§ç»­';
            } else {
                document.getElementById('startMenu').style.display = 'none';
            }
        }

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            game.keys[e.code] = true;
            
            // æ•°å­—é”®åˆ‡æ¢æ–¹å—ï¼ˆä¿ç•™åŸºäº e.key çš„åˆ¤æ–­ï¼‰
            if (e.key >= '1' && e.key <= '9') {
                const slots = document.querySelectorAll('.inventory-slot');
                const index = parseInt(e.key) - 1;
                if (slots[index]) {
                    slots.forEach(s => s.classList.remove('active'));
                    slots[index].classList.add('active');
                    game.selectedBlock = slots[index].dataset.block;
                    showMessage(`é€‰æ‹©äº† ${blockTypes[game.selectedBlock].icon} æ–¹å—`);
                }
            }
            
            // ESC æš‚åœ
            if (e.key === 'Escape') {
                togglePause();
            }
        });

        document.addEventListener('keyup', (e) => {
            // æ¸…ç†çŠ¶æ€
            game.keys[e.code] = false;

            // åœ¨ keyup æ—¶åˆ‡æ¢é£è¡Œï¼Œé¿å…æŒ‰ä½äº§ç”Ÿå¤šæ¬¡åˆ‡æ¢
            if (e.code === 'KeyF') {
                game.player.flying = !game.player.flying;
                showMessage(game.player.flying ? 'é£è¡Œæ¨¡å¼å¼€å¯' : 'é£è¡Œæ¨¡å¼å…³é—­');
            }
        });

        // é¼ æ ‡äº‹ä»¶
        canvas.addEventListener('click', (e) => {
            if (!game.isStarted || game.isPaused) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // æ”¾ç½®æ–¹å—
            const target = getTargetBlock();
            if (target) {
                // åœ¨ç›®æ ‡æ–¹å—æ—è¾¹æ”¾ç½®æ–°æ–¹å—
                const positions = [
                    { x: target.x + 1, y: target.y, z: target.z },
                    { x: target.x - 1, y: target.y, z: target.z },
                    { x: target.x, y: target.y + 1, z: target.z },
                    { x: target.x, y: target.y - 1, z: target.z },
                    { x: target.x, y: target.y, z: target.z + 1 },
                    { x: target.x, y: target.y, z: target.z - 1 }
                ];
                
                for (let pos of positions) {
                    if (!getBlock(pos.x, pos.y, pos.z)) {
                        setBlock(pos.x, pos.y, pos.z, game.selectedBlock);
                        showMessage(`æ”¾ç½®äº† ${blockTypes[game.selectedBlock].icon} æ–¹å—`);
                        break;
                    }
                }
            }
        });

        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (!game.isStarted || game.isPaused) return;
            
            // ç ´åæ–¹å—
            const target = getTargetBlock();
            if (target) {
                setBlock(target.x, target.y, target.z, null);
                showMessage(`ç ´åäº† ${blockTypes[target.type].icon} æ–¹å—`);
            }
        });

        // åº“å­˜æ ç‚¹å‡»
        document.querySelectorAll('.inventory-slot').forEach((slot, index) => {
            slot.addEventListener('click', () => {
                document.querySelectorAll('.inventory-slot').forEach(s => s.classList.remove('active'));
                slot.classList.add('active');
                game.selectedBlock = slot.dataset.block;
                showMessage(`é€‰æ‹©äº† ${blockTypes[game.selectedBlock].icon} æ–¹å—`);
            });
        });

        // é˜²æ­¢é¡µé¢æ»šåŠ¨
        window.addEventListener('wheel', (e) => {
            if (game.isStarted && !game.isPaused) {
                e.preventDefault();
            }
        }, { passive: false });

        // å¯åŠ¨æ¸¸æˆå¾ªç¯
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
